{# {% from '_utils.html' import info_block %} #}
{% set title = 'Add fields to CSV' %}
{% extends "base.html.j2" %}

{% block headscripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.1.0/papaparse.min.js" integrity="sha256-Fh801SO9gqegfUdkDxyzXzIUPWzO/Vatqj8uN+5xcL4=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/core.min.js" integrity="sha256-hV6Ff1ZbnLObO8BWHPZs1oA3aPZkX4bnnEKO4nX1sm0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/md5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
{% endblock %}

{% block content %}
<form action="" method="post" enctype="multipart/form-data" class="w-100 w-70-l fl-l pr3-l">
  <div class="w-100 mb4 entry-content cf">
    <p class="measure">Add data to a CSV file by looking it up from a column with a charity number or other organisation identifier.</p>
    <p class="measure">The file should be separated by commas (<code>,</code>) - not semicolons or tabs)
    and the first row should contain the column names.</p>
    <a class="dn-l link underline blue f5" href="#privacy">See important note on privacy below</a>
  </div>
  <div class="w-100 b--light-gray ba bw1 br3 mb4" id="addtocsv">

    <div class="w-100 pa2 b--light-gray bb bw1 stage" id="stage-select-file">
      <h3 class="pa0 ma0 dib">
        Step 1: 
        <span class="normal">Select CSV file</span>
      </h3>
      <span class="fr contents-top" v-if="stage > 0">
        <a href="#" id="reset-select-file" class="stage-reset link f6 blue underline dim" v-on:click.prevent="csv = null">Change file</a>
        <span class="file-name dib code pa1 bg-light-gray lh-solid" id="csvfilename">[[filename]]</span>
      </span>
      <div class="contents mv3" v-else-if="stage == 0">
        <label class="file-label">
          <input class="file-input w-100" type="file" name="csvfile" id="csvfile" accept="text/csv,.csv" v-on:change="selectFile">
          <span class="file-cta">
            <span class="file-icon">
              <i class="fas fa-upload"></i>
            </span>
            <span class="file-label">
              Choose a file…
            </span>
          </span>
        </label>
        <div class="file has-name is-fullwidth">
        </div>
        <p class="gray f6 pa0 ma0">
          Files with a large number of rows will cause
          your browser to slow and may not complete successfully.
        </p>

      </div>
    </div>

    <div class="w-100 pa2 b--light-gray bb bw1 stage" id="stage-select-postcode-field">
      <h3 class="pa0 ma0 dib">
        Step 2: 
        <span class="normal">Select postcode field</span>
      </h3>
      <span class="fr contents-top" v-if="stage > 1">
        <a href="#" id="reset-select-postcode-field" class="stage-reset link f6 blue underline dim" v-on:click.prevent="column_to_use = null">Change field</a>
        <span class="dib code pa1 bg-light-gray lh-solid" id="column-name-desc">[[column_to_use]]</span>
        <input class="dn" type="text" name="column_name" id="column_name" :value="column_to_use">
      </span>
      <div class="contents mv4" v-else-if="stage == 1">
        <div class="field mb3" id="csvpreview">
          <ul class="list pa0 ma0">
            <li v-for="f in field_select" class="mb2">
                <label class="pointer">
                    <input type="radio" name="postcode_field" :value=[[f.name]] v-on:click.prevent="column_to_use = f.name" />
                    <span class="code pa1 bg-light-gray underline-hover">[[f.name]]</span>
                    <ul class="list pa0 ma0">
                        <li class="dib mr2 gray mt1 f6 tl truncate mw5" v-for="v in f.example_values">[[v]]</li>
                    </ul>
                </label>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <div class="w-100 pa2 b--light-gray bb bw1 stage" id="stage-select-fields">
      <h3 class="pa0 ma0 dib">
        Step 3: 
        <span class="normal">Select data to add</span>
      </h3>
      <span class="fr contents-top" v-if="stage > 2">
        <span class="dib code pa1 bg-light-gray" id="fields_to_add"></span>
      </span>
      <div class="contents mv4" v-else-if="stage == 2">
        <ul class="list ma0 pa0">
            <li v-for="field in fields" :key="field.id">
                <label>
                    <input type="checkbox" name="fields" :value="field.id" v-model="fields_to_add">
                    [[field.name]]
                </label>
            </li>
        </ul>
        
        <div class="contents mv4">
            <input class="button-reset bn pv3 ph4 b tc bg-animate bg-yellow dim near-black pointer br2-ns ml4-l" type="submit" 
                   value="Add data to CSV" id='fetch_postcodes' v-on:click.prevent="getResults" />
            <div id="result" v-if="progress !== null">
                <p class="pa0 mv3 mh2" id="result-text">Creating file…</p>
                <div id="progress-bar" class="bg-light-blue h2 mt4 mh2">
                    <div class="progress-bar-inner bg-blue h2 ph3 pv1 f6 tr white" v-bind:style="{ width: progress + '%' }" id="progress-bar-inner">[[progress]]%</div>
                </div>
            </div>
        </div>
      </div>
      
    </div>

  </div>
</form>

<div class="content w-100 w-30-l fl-l pa3 bg-light-gray f5" id="privacy">
  <h3 class="pa0 ma0 header-font">Privacy</h3>
  <p class="">Your file will not leave your own computer and no data from it is directly sent to findthatcharity.</p>
  <p class="">
    To protect your privacy this script does not send the organisation identifiers found in your file.
    Instead a code is created based on the organisation identifier, and this code
    is sent to findthatcharity.
  </p>
  <p>
    This code will correspond to a number of different organisation identifiers (around 30),
    and all organisation identifiers that match this code are sent back to the browser to be matched.
  </p>
  <p>
    This provides some level of privacy protection, but in some circumstances it could still be possible to make a reasonable guess
    as to the organisation identifier used in the file by looking at the codes requested.
  </p>
  <p class="b">Therefore it is recommended
    that you think carefully before using this tool with any personal or sensitive data.
  </p>
</div>
{% endblock %}

{% block bodyscripts %}
<script type="text/javascript">
const PROPERTIES_URL = {{ request.build_absolute_uri(url('propose_properties'))|tojson }};
const EXTEND_URL = {{ request.build_absolute_uri(url('reconcile'))|tojson }};
</script>
<script src='{{ static("js/csv.js") }}' type="text/javascript"></script>
{% endblock %}